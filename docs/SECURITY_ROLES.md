# نقش‌ها و دسترسی‌ها در OGIM

| نقش             | توضیح کوتاه                                    | دسترسی‌ها (سرویس‌ها)                                                                                             |
|-----------------|------------------------------------------------|-------------------------------------------------------------------------------------------------------------------|
| `system_admin`  | مدیر سامانه با دسترسی کامل                     | همه‌ی سرویس‌ها، مدیریت کاربر، مدیریت فرمان، مدیریت کاتالوگ، مدیریت اتصال‌ها، اجرای migrations                    |
| `data_engineer` | مسئول داده و آنالیز                            | مشاهده/مدیریت ingestion، مشاهده هشدارها، مدیریت tagها (بدون حذف کامل)، دسترسی به مدل‌های ML                      |
| `field_operator`| اپراتور میدانی                                 | مشاهده هشدارها، ایجاد فرمان (بدون approve)، استفاده از inference، مشاهده داده‌های ingestion                      |
| `operator`      | اپراتور کنترل                                 | ایجاد فرمان‌های کنترلی محدود، مشاهده لیست فرمان‌ها                                                               |
| `viewer`        | دسترسی فقط خواندنی                             | مشاهده داشبورد و گزارش‌ها از طریق API Gateway (صرفاً endpoints read-only)                                       |

## سیاست‌های کلی
- همه درخواست‌ها باید یک توکن Bearer معتبر ارائه دهند؛ نقش و `sub` از توکن استخراج و در gateway و سرویس‌ها بررسی می‌شود.
- عملیات حساس (ایجاد/تأیید فرمان، مدیریت Tag، تنظیمات اتصال، تغییر نقش) نیازمند `system_admin` یا نقش مشخص‌شده است.
- ثبت audit برای عملیات فرمان، ایجاد هشدار، و مدیریت کاربر انجام می‌شود؛ لاگ‌ها در فرمت JSON ذخیره می‌شوند.
- نرخ تلاش‌های ناموفق ورود محدود شده و در صورت عبور از آستانهٔ ۵ تلاش در ساعت هشدار امنیتی ثبت می‌شود.

## مسیرهای مرتبط
- احراز هویت: `auth-service` (`/token`, `/refresh`, `/users`).  
- کنترل نقش‌ها در gateway: فایل `backend/api-gateway/main.py` (`SERVICE_ROLE_REQUIREMENTS`).  
- وابستگی‌های نقش در هر سرویس:  
  - `alert-service/main.py`: `require_alert_read/write/admin`  
  - `command-control-service/main.py`: `require_command_read/admin`  
  - `tag-catalog-service/main.py`: `require_tag_read/write/admin`  
  - `data-ingestion-service/main.py`: `require_ingest_read/admin`

برای افزودن یا اصلاح نقش‌ها، ابتدا policy را در این سند به‌روزرسانی کنید، سپس mapping را در gateway و سرویس مربوطه اعمال و تست کنید.*** End Patch

